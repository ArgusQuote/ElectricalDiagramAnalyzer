---
description: Documentation for RulesEngine and PartNumberBuilder - business logic and part selection
globs: 
  - RulesEngine/**/*
  - PartNumberSelector/**/*
alwaysApply: false
---

# Rules Engine Documentation

## Directory Structure

```
RulesEngine/
└── RulesEngine2.py           # Main rules engine

PartNumberSelector/
└── PartNumberBuilder.py      # Part number generation classes
```

## Purpose

The Rules Engine transforms detected panel data into actionable part numbers:
1. Validates and normalizes detected values
2. Applies business rules for product selection
3. Generates Square D part numbers with quantities

---

## RulesEngine2.py

### Main Entry Point

```python
def process_job(payload: dict) -> dict:
    """
    payload = {
        "defaults": {...},    # UI overrides (material, trim, enclosure, etc.)
        "items": [...]        # List of component dicts from OCR
    }

    Returns:
    {
        "panels": [
            {
                "name": "DP-1",
                "source": "/path/to/image.png",
                "inputAttrs": {...},
                "resolvedAttrs": {...},
                "parts": [
                    {"partNumber": "NQ430L2C", "qty": 1, "type": "panelboard"},
                    {"partNumber": "QOB220", "qty": 5, "type": "breaker"},
                    ...
                ],
                "notes": ["..."]
            }
        ]
    }
    """
```

### UI Defaults

```python
def ui_defaults():
    return {
        "panelboards": {
            "bussing_material": "ALUMINUM",       # or "COPPER"
            "allow_plug_on_breakers": True,
            "rating_type": "FULLY_RATED",         # or "SERIES_RATED"
            "allow_feed_thru_lugs": True,
            "default_trim_style": "FLUSH",        # or "SURFACE"
            "enclosure": "NEMA1",                 # or "NEMA3R"
            "allow_square_d_spd": True,
        },
        "transformers": {
            "winding_material": "ALUMINUM",
            "temperature_rating": 150,
            "default_type": "3PHASESTANDARD",
            "weathershield": False,
            "mounting": "FLOOR",
            "resin_enclosure": "3R",
        },
        "disconnects": {
            "allow_littlefuse": True,
            "default_switch_type": "GENERAL_DUTY",
            "default_enclosure": "NEMA1",
            "default_fusible": True,
            "default_ground_required": True,
            "default_solid_neutral": True,
        },
    }
```

### Interrupting Rating Logic

```python
INTERRUPTING_RATINGS = {
    'B': { 240:[25,65,100], 480:[18,35,65], 600:[14,18,25,65] },
    'H': { 240:[25,65,100,125,200], 480:[18,35,65,100,200], 600:[14,18,25,50,100] },
    'J': { 240:[25,65,100,125,200], 480:[18,35,65,100,200], 600:[14,18,25,50,100] },
    # ... Q, L, LL, M, P, R frames
}

DEFAULT_INTERRUPTING_RATING = 22  # kAIC default when not detected

def apply_interrupting_rating_defaults(raw: dict) -> dict:
    """Applies default 22 kAIC if not detected."""
```

### Space Snapping

Valid panel sizes: `18, 30, 42, 54, 66, 72, 84`

```python
def _snap_spaces(detected: int) -> int:
    """Snaps detected space count to nearest valid size."""
    for v in [18, 30, 42, 54, 66, 72, 84]:
        if v >= detected:
            return v
    return 84
```

### 2-Pole Phase Balancing

For 2-pole breakers, the engine balances load across phases:

```python
HJ_2P_ALLOWED = {
    "H": {
        "D": {
            "AB": {15,20,25,30,...},
            "AC": {15,20,25,30,...},
            "BA": {15,25,30,...},
            # ...
        },
        # ...
    },
    "J": {...}
}

def pick_balanced_pair(phase_load: dict, pairs: list, weight: float) -> str:
    """Picks phase pair (AB, AC, BC, etc.) that minimizes load imbalance."""
```

---

## PartNumberBuilder.py

Contains multiple builder classes for different product types.

### Disconnect Builder

```python
class Disconnect:
    disconnectLibrary = {
        # (switchType, fusible, poles, voltage, amps, enclosure): (partNumber, groundKit, neutralKit)
        ('GENERAL_DUTY', True, 2, 240, 30, 'NEMA1'):  ("D211N", "PK3GTA1", None),
        ('GENERAL_DUTY', True, 2, 240, 30, 'NEMA3R'): ("D211NRB", "PK3GTA1", None),
        # ... many more entries
        ('HEAVY_DUTY', False, 3, 600, 1200, 'NEMA3R'): ("HU368R", "PKOGTA8", "H1200SNE4"),
    }

    def generateDisconnectPartNumber(self, attributes: dict) -> dict:
        """
        attributes = {
            "switchType": "GENERAL_DUTY" or "HEAVY_DUTY",
            "fusible": bool,
            "poles": 2 or 3,
            "voltage": 240 or 600,
            "amps": int,
            "enclosure": "NEMA1" or "NEMA3R",
            "groundRequired": bool,
            "solidNeutral": bool,
            "fuseAmperage": int (optional)
        }

        Returns:
        {
            "Part Number": "D322N",
            "Grounding Kit": "GTK03",
            "Solid Neutral Kit": "SN0610",
            "Fuses": "3 - FLNR060"
        }
        """
```

### Breaker Selector

```python
class breakerSelector:
    def __init__(self, attributes):
        self.breakerType = attributes.get("breakerType")  # QO, QOB, HOM, QH, QHB, etc.
        self.poles = attributes.get("poles")              # 1, 2, 3
        self.amperage = attributes.get("amperage")        # 15-1200
        self.interruptionRating = attributes.get("interruptionRating")
        self.specialFeatures = attributes.get("specialFeatures")  # GFI, AFI, etc.
        self.iline = attributes.get("iline", False)       # I-Line panel breakers

    def generateBreakerPartNumber(self) -> str:
        """Returns part number like 'QOB220', 'HOM115', 'QH3100'"""
```

### Panel Builders

```python
# NQ Panelboard (bolt-on, commercial)
class nqPanelboard:
    def generatePanelboardPartNumber(self, attributes: dict) -> dict

# NF Panelboard (flush mount)
class nfPanelboard:
    def generatePanelboardPartNumber(self, attributes: dict) -> dict

# I-Line Panelboard (high capacity)
class iLinePanelboard:
    def generatePanelboardPartNumber(self, attributes: dict) -> dict

# Load Center (residential)
class loadcenter:
    def generateLoadcenterPartNumber(self, attributes: dict) -> dict
```

### MCCB (Molded Case Circuit Breaker)

```python
class mccb:
    def generateMCCBPartNumber(self, attributes: dict) -> str
    """
    For main breakers and large frame breakers:
    - H-frame: 15-150A
    - J-frame: 150-250A
    - L-frame: 250-600A
    - M-frame: 300-800A
    - P-frame: 600-1200A
    """
```

### Transformer Builder

```python
class transformer:
    def generateTransformerPartNumber(self, attributes: dict) -> dict
    """
    Supports:
    - 3-phase standard (EX/EXN families)
    - 1-phase (S1/S3 families)
    - K-13 rated (K-factor transformers)
    - Resin-encapsulated (EE families)
    """
```

### Blanks

```python
class blanks:
    def getBlanks(self, attributes: dict) -> dict
    """
    Generates blank fillers for unused spaces:
    - QOB blanks
    - QO blanks
    - HOM blanks
    """
```

---

## Processing Flow

```
1. Input: Component from OCR
   {
       "type": "panelboard",
       "name": "DP-1",
       "attrs": {
           "amperage": 400,
           "spaces": 42,
           "voltage": 208,
           "intRating": 22,
           "mainBreakerAmperage": 400,
           "detected_breakers": [...]
       }
   }

2. Validation & Normalization:
   - Snap spaces to valid size (42 → 42 ✓)
   - Validate voltage (208 ∈ {120,208,240,480,600} ✓)
   - Apply default int rating if missing (22 kAIC)

3. Panel Type Selection:
   - Check amperage range → NQ vs I-Line
   - Check spaces → determine size suffix
   - Check enclosure → NEMA1/NEMA3R suffix

4. Main Breaker Selection:
   - If mainBreakerAmperage present → generate MCCB
   - Select frame (H/J/L/M/P) based on amperage
   - Apply interrupting rating

5. Branch Breaker Selection:
   - For each detected_breaker:
     - Select breaker type (QOB/QO/HOM based on panel type)
     - Apply poles and amperage
     - Add special features (GFI/AFI if description suggests)

6. Accessories:
   - Feed-thru lugs (if enabled)
   - SPD (surge protective device)
   - Cover/trim based on style
   - Ground bar, neutral bar

7. Output: Part list with quantities
   {
       "parts": [
           {"partNumber": "NQ430L2C", "qty": 1, "type": "panelboard"},
           {"partNumber": "QOB220", "qty": 10, "type": "breaker"},
           {"partNumber": "QO120", "qty": 5, "type": "breaker"},
           {"partNumber": "PKFTL", "qty": 1, "type": "feed-thru-lugs"},
           {"partNumber": "QO2175SB", "qty": 1, "type": "spd"},
           ...
       ]
   }
```

---

## Key Constants

### Amperage Ranges by Frame

| Frame | Min | Max | Notes |
|-------|-----|-----|-------|
| B | 15 | 100 | Bolt-on, residential |
| H | 15 | 150 | Standard commercial |
| J | 150 | 250 | Medium capacity |
| L | 250 | 600 | Large capacity |
| M | 300 | 800 | Heavy duty |
| P | 600 | 1200 | Maximum capacity |
| R | 600 | 1200 | High interrupt |

### Panel Size Matrix

| Spaces | NQ Part Suffix | Notes |
|--------|---------------|-------|
| 18 | L1 | Compact |
| 30 | L1 | Standard |
| 42 | L2 | Standard |
| 54 | L3 | Extended |
| 66 | L3 | Extended |
| 72 | L4 | Large |
| 84 | L4 | Maximum |

---

## Error Handling

- Invalid configurations return error string instead of dict
- Notes array captures warnings and applied defaults
- Missing interrupting rating: defaults to 22 kAIC with note
- Breaker validation failures: suppressed with explanatory note

---

## Related Documentation

- [Application Overview](mdc:.cursor/rules/docs/application-overview.mdc) - High-level system architecture
- [Uplink Server](mdc:.cursor/rules/docs/uplink-server.mdc) - How rules engine is called from the server
- [OCR Library](mdc:.cursor/rules/docs/ocr-library.mdc) - OCR parsing that provides input to rules engine
- [Project Structure](mdc:.cursor/rules/reference/project-structure.mdc) - Complete file listing
