---
description: Common image processing and OpenCV errors
globs: 
  - VisualDetectionToolLibrary/**/*
  - OcrLibrary/**/*
  - PageFilter/**/*
alwaysApply: false
---

# Image Processing Errors

Common errors encountered during image processing with OpenCV and PyMuPDF.

---

## Error: Empty Image Array

**Summary**: OpenCV function receives empty or None image array.

**Root Cause**:
- PDF page failed to render
- File path incorrect or file missing
- Image read with wrong color mode

**Symptoms**:
- `cv2.error: (-215:Assertion failed) !_src.empty()`
- NoneType errors on image operations
- Zero-dimension array errors

**Prevention**:
- Always check `img is not None` after reading
- Verify file paths before processing
- Use try/except around image loading

**Fix**:
```python
# Before (crashes on missing file)
img = cv2.imread(path)
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# After (handles missing gracefully)
img = cv2.imread(path)
if img is None:
    raise FileNotFoundError(f"Could not read image: {path}")
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
```

**Related**:
- [panel-detection.mdc](mdc:.cursor/rules/docs/panel-detection.mdc)
- `VisualDetectionToolLibrary/PanelSearchToolV21.py`

---

## Error: PDF Render Failure

**Summary**: PyMuPDF fails to render page to image.

**Root Cause**:
- Corrupted PDF file
- Page index out of bounds
- Insufficient memory for high-DPI render

**Symptoms**:
- `fitz.fitz.FileDataError`
- Black or blank rendered images
- Memory errors on large PDFs

**Prevention**:
- Validate PDF before processing
- Use reasonable DPI (150-300)
- Process pages sequentially to limit memory

**Fix**:
```python
# Before (may fail silently)
pix = page.get_pixmap(matrix=fitz.Matrix(dpi/72, dpi/72))

# After (with validation)
try:
    pix = page.get_pixmap(matrix=fitz.Matrix(dpi/72, dpi/72))
    if pix.width == 0 or pix.height == 0:
        raise ValueError(f"Page {page.number} rendered empty")
except Exception as e:
    logging.error(f"Failed to render page {page.number}: {e}")
    raise
```

**Related**:
- [page-filter.mdc](mdc:.cursor/rules/docs/page-filter.mdc)
- `PageFilter/PageFilterV2.py`

---

## Error: Grid Lines Not Detected

**Summary**: Morphological operations fail to find table grid lines.

**Root Cause**:
- Lines too thin at current resolution
- Image noise interferes with detection
- Kernel size inappropriate for line thickness

**Symptoms**:
- Empty or few horizontal/vertical lines detected
- Table structure not recognized
- Breaker rows incorrectly grouped

**Prevention**:
- Upscale image if height < 1600px
- Apply Gaussian blur to reduce noise
- Use adaptive kernel sizes based on image dimensions

**Fix**:
```python
# Adjust kernel based on image size
H, W = gray.shape
# Horizontal kernel: wide, thin
h_kernel_width = max(W // 30, 20)
h_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (h_kernel_width, 1))

# Vertical kernel: thin, tall
v_kernel_height = max(H // 30, 20)
v_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, v_kernel_height))
```

**Related**:
- [panel-detection.mdc](mdc:.cursor/rules/docs/panel-detection.mdc)
- [ocr-library.mdc](mdc:.cursor/rules/docs/ocr-library.mdc)
- `VisualDetectionToolLibrary/PanelSearchToolV21.py`

---

## Error: Color Space Mismatch

**Summary**: Function expects different color format than provided.

**Root Cause**:
- Mixed BGR/RGB conventions
- Grayscale passed where color expected (or vice versa)
- Alpha channel present when not expected

**Symptoms**:
- Colors appear inverted (red/blue swapped)
- Shape mismatch errors (H,W) vs (H,W,3)
- `cv2.error: (-215:Assertion failed) depth == CV_8U`

**Prevention**:
- Document expected color format in function docstrings
- Convert explicitly at function entry
- Use consistent convention (BGR for OpenCV)

**Fix**:
```python
def process_image(img: np.ndarray) -> np.ndarray:
    """
    Process image for OCR.
    
    Args:
        img: BGR image array (H, W, 3)
    """
    # Ensure correct format
    if len(img.shape) == 2:
        img = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)
    elif img.shape[2] == 4:
        img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)
    # ...
```

**Related**:
- [ocr-library.mdc](mdc:.cursor/rules/docs/ocr-library.mdc)
- `OcrLibrary/BreakerTableAnalyzer12.py`

---

## Adding New Errors

When you fix an image processing bug, document it here:

1. Copy error template from [_template.mdc](mdc:.cursor/rules/common-errors/_template.mdc)
2. Fill in all sections with specific error messages
3. Include before/after code examples
4. Add cross-references to relevant files

See: [documentation-standards.mdc](mdc:.cursor/rules/core/documentation-standards.mdc)
