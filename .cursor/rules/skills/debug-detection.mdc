---
description: Skill for debugging panel detection and PDF processing issues
globs:
  - VisualDetectionToolLibrary/**/*
  - PageFilter/**/*
alwaysApply: false
---

# @debug-detection - Panel Detection Debugging Skill

Invoke with `@debug-detection` when troubleshooting panel detection or PDF processing.

## Diagnostic Workflow

### Step 1: Identify the Symptom

| Symptom | Likely Cause | Jump To |
|---------|--------------|---------|
| No panels found | Void detection thresholds | [Void Detection](#void-detection) |
| Wrong regions detected | Size filters | [Size Filters](#size-filters) |
| Pages dropped incorrectly | Page filter scoring | [Page Filter](#page-filter) |
| Invalid tables folder full | Line spacing validation | [Validation](#validation) |
| Crops contain multiple tables | One-box enforcement | [Multi-Table](#multi-table) |

### Step 2: Enable Debug Mode

```python
# PanelBoardSearch
finder = PanelBoardSearch(
    output_dir="/path/to/output",
    dpi=400,
    debug=True,
    verbose=True,
)
panel_images = finder.readPdf(pdf_path)

# Check debug output:
# - magenta_overlays/ - Visual overlay per page
# - debug_horizontal_lines/ - Line spacing analysis
# - invalid_tables/ - Failed validation
```

### Step 3: Check Overlay Images

| Color | Meaning |
|-------|---------|
| Green boxes | Detected panel/table regions (voids) |
| Red boxes | Raster images NOT inside panel voids |
| Magenta fill | Whitespace regions |

---

## Void Detection

### Problem: No Panels Found

**Check 1:** Are void thresholds appropriate?

```python
PanelBoardSearch(
    min_void_area_fr=0.004,   # Min 0.4% of page area
    max_void_area_fr=0.30,    # Max 30% of page area
    min_void_w_px=90,         # Min width in pixels
    min_void_h_px=90,         # Min height in pixels
)
```

**Fix:** Lower minimum thresholds for smaller panels:
```python
min_void_area_fr=0.002,  # Allow smaller panels
min_void_w_px=60,
min_void_h_px=60,
```

**Check 2:** Is DPI too low?

```python
# At 150 DPI, a 1" panel = 150px
# At 400 DPI, a 1" panel = 400px
dpi=400  # Recommended
```

**Check 3:** Is the panel touching page border?

Voids touching page edges are excluded. Check `border_exclude_px` setting.

---

## Size Filters

### Problem: Wrong Regions Detected

**Check 1:** Aspect ratio filters

```python
void_w_fr_range=(0.10, 0.60),  # Width: 10-60% of page
void_h_fr_range=(0.10, 0.60),  # Height: 10-60% of page
```

**Fix:** Widen ranges for unusual panel shapes:
```python
void_w_fr_range=(0.08, 0.70),
void_h_fr_range=(0.08, 0.70),
```

**Check 2:** Whitespace requirements

```python
min_whitespace_area_fr=0.01  # Surrounding whitespace
```

---

## Page Filter

### Problem: Pages Dropped Incorrectly

**Check 1:** Enable debug mode

```python
pf = PageFilter(
    output_dir="/path/to/output",
    debug=True,
    verbose=True,
)
kept, dropped, filtered_pdf, log_json = pf.readPdf(pdf_path)

# Check log_json for decision reasons
```

**Check 2:** Scoring thresholds

```python
hard_hit_score=6.5,  # Gold threshold (keep)
min_hit_score=3.0,   # Soft threshold
```

**Fix:** Lower thresholds to keep more pages:
```python
hard_hit_score=5.0,
min_hit_score=2.0,
```

**Check 3:** E-sheet pattern matching

```python
pattern_e_loose=r"^E[A-Z\-]{0,5}.*\d.*\d"
# Matches: E-101, E2.01, EA-1.2
```

**Fix:** Adjust pattern for unusual naming:
```python
pattern_e_loose=r"^E.*\d"  # More permissive
```

---

## Validation

### Problem: Valid Tables in invalid_tables/

**Check 1:** Line spacing validation

```python
def _is_valid_table_spacing(
    metrics,
    mask_width,
    spacing_tol_px=4,     # Tolerance for line spacing
    min_repeats=5,        # Need 5+ consistent lines
    min_len_frac=0.5,     # Lines must span 50% of width
):
```

**Fix:** Relax validation:
```python
spacing_tol_px=8,    # More tolerance
min_repeats=3,       # Fewer required lines
min_len_frac=0.3,    # Shorter lines OK
```

**Check 2:** Horizontal line detection

Look at `debug_horizontal_lines/` for detected lines. If no lines found, the image may not have clear grid lines.

---

## Multi-Table

### Problem: Single Crop Contains Multiple Tables

**Check 1:** Is one-box enforcement enabled?

```python
enforce_one_box=True,     # Split multi-table crops
replace_multibox=True,    # Delete original after split
```

**Check 2:** Look at split results

The enforcement should create:
- `*_panel01.png`
- `*_panel01_split_1.png`
- `*_panel01_split_2.png`

**Fix:** Adjust NMS threshold:
```python
# In _enforce_one_box_on_paths
# IoU threshold for NMS
iou_thresh=0.3  # Lower = more aggressive deduplication
```

---

## PDF Rendering Issues

### Problem: Blank or Black Images

**Check 1:** DPI settings

```python
dpi=400,           # Detection DPI
render_dpi=1200,   # Output PNG DPI
```

**Check 2:** Memory constraints

High DPI + large pages = high memory. Try:
```python
dpi=300,
render_dpi=800,
```

**Check 3:** PDF corruption

```python
import fitz
doc = fitz.open(pdf_path)
for page in doc:
    print(f"Page {page.number}: {page.rect}")
```

---

## Quick Fixes

### Skip Page Filter

```python
# Process all pages without filtering
finder = PanelBoardSearch(output_dir=output_dir)
panels = finder.readPdf(original_pdf)  # Skip PageFilter
```

### Force Keep Specific Pages

```python
# In PageFilter, manually override decisions
kept_pages = [1, 3, 5]  # Force keep these
```

### Bypass Validation

```python
# Don't move invalid tables
# Comment out _save_horizontal_line_masks call
```

---

## Files to Check

| Issue | Primary File | Method |
|-------|--------------|--------|
| Void detection | `PanelSearchToolV24.py` | `_components()` |
| Size filtering | `PanelSearchToolV24.py` | Constructor params |
| Page filtering | `PageFilterV3.py` | `readPdf()` |
| Line validation | `PanelSearchToolV24.py` | `_save_horizontal_line_masks()` |
| One-box split | `PanelSearchToolV24.py` | `_enforce_one_box_on_paths()` |
| PDF rendering | `PanelSearchToolV24.py` | `readPdf()` â†’ fitz calls |
