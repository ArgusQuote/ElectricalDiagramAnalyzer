---
description: Documentation for the visual panel detection tools in VisualDetectionToolLibrary
globs: VisualDetectionToolLibrary/**/*
alwaysApply: false
---

# Panel Detection Documentation

## File Location
- **Latest**: `VisualDetectionToolLibrary/PanelSearchToolV21.py`
- **Legacy**: V15, V17, V18, V19, V20 (historical iterations)

## Purpose
Detects panel board schedule tables ("voids") in PDF pages and extracts high-quality image crops for OCR processing.

## Main Class: `PanelBoardSearch`

### Constructor Parameters

```python
PanelBoardSearch(
    output_dir: str,              # Where to save outputs
    
    # Detection settings
    dpi: int = 400,               # Detection DPI (fitz rendering)
    render_dpi: int = 1200,       # Final PNG output DPI
    aa_level: int = 8,            # Anti-aliasing 0-8
    render_colorspace: str = "gray",  # "gray" or "rgb"
    
    # Void detection thresholds
    min_void_area_fr: float = 0.004,   # Min area as fraction of page
    max_void_area_fr: float = 0.30,    # Max area fraction
    min_void_w_px: int = 90,           # Min width in pixels
    min_void_h_px: int = 90,           # Min height in pixels
    void_w_fr_range: tuple = (0.10, 0.60),  # Width range as page fraction
    void_h_fr_range: tuple = (0.10, 0.60),  # Height range as page fraction
    
    # Whitespace analysis
    min_whitespace_area_fr: float = 0.01,
    margin_shave_px: int = 6,
    border_exclude_px: int = 4,
    
    # Post-processing
    enforce_one_box: bool = True,      # Split multi-table crops
    replace_multibox: bool = True,     # Delete original after split
    pad: int = 6,                      # Padding around crops
    
    debug: bool = False,
    verbose: bool = True,
)
```

### Public API

#### `readPdf(pdf_path: str) -> list[str]`
Main entry point. Returns list of output PNG paths.

**Pipeline**:
1. Render each page at detection DPI
2. Binarize ink → extract whitespace mask
3. Find connected components → detect "holes" (voids)
4. Validate void dimensions against thresholds
5. Export vector PDF crops + high-DPI PNG crops
6. Validate horizontal line spacing
7. Enforce one-box-per-crop rule
8. Extract raster images and augment overlays

### Output Structure

```
output_dir/
├── <base>_page001_panel01.png     # Main panel crops
├── <base>_page001_panel02.png
├── magenta_overlays/              # Debug overlays per page
│   └── <base>_page001_void_perimeters.png
├── cropped_tables_pdf/            # Vector PDF crops (lossless)
│   └── <base>_page001_panel01.pdf
├── raster_images/                 # Embedded raster extractions
├── invalid_tables/                # Crops that failed validation
└── debug_horizontal_lines/        # Line spacing analysis (if debug=True)
```

## Key Internal Methods

### `_binarize_ink(gray, close_px, dilate_px)`
Converts grayscale to binary ink mask using Otsu thresholding.

### `_components(mask)`
Runs connected components analysis on whitespace mask.

### `_grid_proposals_fallback(img_bgr)`
Fallback when hole detection yields nothing - uses edge/line detection to find table-like structures.

### `_save_horizontal_line_masks(image_paths)`
**Critical validation step**:
- Detects horizontal lines in each crop
- Measures line spacing consistency
- Moves invalid tables to `invalid_tables/` directory

```python
def _is_valid_table_spacing(
    metrics: list,           # [(line_idx, delta_y, length), ...]
    mask_width: int,
    spacing_tol_px: int = 4,
    min_repeats: int = 5,    # Need 5+ lines with consistent spacing
    min_len_frac: float = 0.5,
) -> bool
```

### `_enforce_one_box_on_paths(image_paths)`
Ensures each output PNG contains only one table:
- Re-detects table boxes in each crop
- If multiple tables found, splits into separate files
- Uses NMS to avoid duplicate detections

### `_find_table_boxes(img_bgr, ...)`
Detects table bounding boxes using:
- Adaptive thresholding
- Horizontal/vertical line extraction
- Contour analysis with size/aspect filters

### `_extract_rasters_and_augment_magenta(pdf_path, page_void_boxes)`
Second pass over PDF:
- Extracts embedded raster images
- Draws red boxes for rasters on overlay PNGs
- Skips rasters that overlap detected panel voids (IoU > 0.5)

## Detection Algorithm

```
1. For each PDF page:
   a. Render at detection DPI (AA=0 for crisp lines)
   b. Convert to grayscale
   c. Binarize ink: GaussianBlur → Otsu threshold → morphology
   d. Invert to get whitespace mask
   e. Shave margins
   
2. Connected components on whitespace:
   a. Keep components with area ≥ min_whitespace_area_fr
   b. Find contours with RETR_CCOMP (2-level hierarchy)
   c. "Holes" inside whitespace = candidate panel voids
   
3. For each hole/void candidate:
   a. Check bounding box against size thresholds
   b. Check not touching page border
   c. Map pixel coords → PDF coords
   d. Clip and export as PDF + PNG
   
4. If no candidates found:
   a. Run grid_proposals_fallback (edge detection)
   b. Apply same size filters
   
5. Post-processing:
   a. Validate horizontal line spacing
   b. Split multi-table crops
   c. Extract loose raster images
```

## Overlay Colors

- **Green boxes**: Detected panel/table regions (voids)
- **Red boxes**: Raster images NOT inside panel voids

## Version Note

> **Important**: The server (`uplink_server.py`) currently imports `PanelSearchToolV11` from bytecode cache, though `V21` is the latest source file. The documentation here covers V21 features. Check `uplink_server.py` imports for the actually-used version.

## Common Tuning Points

| Parameter | Effect of Increasing |
|-----------|---------------------|
| `min_void_area_fr` | Filters out smaller panels |
| `void_w_fr_range[1]` | Allows wider panels |
| `min_whitespace_area_fr` | Requires larger surrounding whitespace |
| `min_repeats` (in validation) | Stricter table validation |
| `spacing_tol_px` | More tolerance for irregular line spacing |

## Usage Example

```python
from VisualDetectionToolLibrary.PanelSearchToolV21 import PanelBoardSearch

finder = PanelBoardSearch(
    output_dir="/path/to/output",
    dpi=400,
    debug=True,
    verbose=True,
)

panel_images = finder.readPdf("/path/to/electrical.pdf")
# Returns: ["/path/to/output/electrical_page001_panel01.png", ...]
```

---

## Related Documentation

- [Application Overview](mdc:.cursor/rules/docs/application-overview.mdc) - High-level system architecture
- [Uplink Server](mdc:.cursor/rules/docs/uplink-server.mdc) - How panel detection is called from the server
- [Page Filter](mdc:.cursor/rules/docs/page-filter.mdc) - PDF filtering that runs before panel detection
- [OCR Library](mdc:.cursor/rules/docs/ocr-library.mdc) - OCR parsing that runs after panel detection
- [Project Structure](mdc:.cursor/rules/reference/project-structure.mdc) - Complete file listing
