import anvil.email
import anvil.users
import anvil.tables as tables
import anvil.tables.query as q
from anvil.tables import app_tables
import anvil.server
from datetime import datetime

@anvil.server.callable
def record_tos_acceptance(required_version: int):
  user = anvil.users.get_user()
  if not user:
    raise ValueError("Not logged in.")
  user['tos_accepted'] = True
  user['tos_accepted_at'] = datetime.utcnow()
  user['tos_version'] = int(required_version)
  return True

@anvil.server.callable
def require_tos_or_bounce():
  user = anvil.users.get_user()
  if not user:
    raise PermissionError("Not logged in.")

  CURRENT_TOS_VERSION = 1
  try:
    tos_ok = bool(user['tos_accepted']) and int(user['tos_version'] or 0) >= CURRENT_TOS_VERSION
  except KeyError:
    tos_ok = False

  if not tos_ok:
    raise PermissionError("Terms of Service not accepted.")
  return True
